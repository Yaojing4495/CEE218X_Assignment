---
title: "assignment1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```
```{r}
library(tidyverse)
library(plotly)
library(zoo)
```

### 6. Publish all of this work in a GitHub webpage titled “yourname_A1” (using the steps from Chapter 1.4). For this assignment, a support script is available by request from the TAs.

## 1 Create bar charts

### 1.1 Read files related to electricity consumption

Time window: From the first quarter of 2017 to the second quarter of 2021

```{r}
years <- 2017:2021
quarters <- 1:4
i=1
type <- "Electric"
pge_17toNow_elec <- NULL

for (year in years){
  for(quarter in quarters){
    filename <- 
    paste0(
      "PGE_",
      year,
      "_Q",
      quarter,
      "_",
      type,
      "UsageByZip.csv"
    )
    print(filename)
    if((quarter>=3)&&(year==2021)){
      next;
      }
    else{
    temp <- read_csv(filename)
    pge_17toNow_elec <- rbind(pge_17toNow_elec,temp)
    
    saveRDS(pge_17toNow_elec, "pge_17toNow_elec.rds")}

    }
}

```
### 1.2 Read files related to gas consumption

Time window: From the first quarter of 2017 to the second quarter of 2021

```{r}
years <- 2017:2021
quarters <- 1:4
i=1
type <- "Gas"
pge_17toNow_gas <- NULL

for (year in years){
  for(quarter in quarters){
    filename <- 
    paste0(
      "PGE_",
      year,
      "_Q",
      quarter,
      "_",
      type,
      "UsageByZip.csv"
    )
    print(filename)
    if((quarter>=3)&&(year==2021)){
      next;
      }
    else{
    temp <- read_csv(filename)
    pge_17toNow_gas <- rbind(pge_17toNow_gas,temp)
    
    saveRDS(pge_17toNow_gas, "pge_17toNow_gas.rds")}
    }
}
```
### 1.3 Obtain a table about residential electricity consumption

Assumption: 1 kBtu=3.412 KWH

```{r}
pge_final_elec_Residential <-
  pge_17toNow_elec %>% 
  filter(
    CUSTOMERCLASS %in% 
      c(
        "Elec- Residential"
      )
  ) %>% 
  select(
    -c(COMBINED, AVERAGEKWH)
  ) %>% 
  group_by(YEAR, MONTH) %>% 
  summarize(
    TOTALKWH = 
      sum(
        TOTALKWH, 
        na.rm = T
      )
  ) %>% 
  mutate(
    Residential_Electric_kBtu=3.412*TOTALKWH,
    Time=as.Date(as.yearmon(paste0(YEAR,'-',MONTH)))
  )
pge_final_elec_Residential
```
### 1.4 Obtain a table about residential gas consumption

Assumption: 1 kBtu=100.00039 THM

```{r}
pge_final_gas_Residential <-
  pge_17toNow_gas %>% 
    filter(
      CUSTOMERCLASS %in% 
        c(
          "Gas- Residential"
        )
    ) %>% 
    select(
      -c(COMBINED, AVERAGETHM)
    ) %>% 
    group_by(YEAR, MONTH) %>% 
    summarize(
      TOTALTHM = 
        sum(
          TOTALTHM, 
          na.rm = T
        )
    ) %>% 
    mutate(
      Residential_Gas_kBtu=100.00039*TOTALTHM,
      Time=as.Date(as.yearmon(paste0(YEAR,'-',MONTH)))
    )
pge_final_gas_Residential
```
### 1.5 Obtain a combined data set of electricity consumption and gas consumption

(1) List the electricity and gas consumption of each month from the first quarter of 2017 to the second quarter of 2021 in chronological order. 

(2) Take kBtu as the unit for statistics.

```{r}
pge_final_GasAndElec_Residential<-
  merge(pge_final_gas_Residential,pge_final_elec_Residential,by=c("YEAR","MONTH","Time"))
  arrange(pge_final_GasAndElec_Residential,pge_final_GasAndElec_Residential$YEAR,pge_final_GasAndElec_Residential$MONTH)
```
### 1.6  Create bar charts showing monthly total kBTUs of residential electricity and gas consumption for the entire PG&E territory 

Time window: from the first quarter of 2017 to the second quarter of 2021

```{r} 
plot_ly() %>% 
  add_trace(
    data = pge_final_GasAndElec_Residential,
    x = ~Time%>% factor(),
    y = ~Residential_Gas_kBtu,
    type = "bar",
    name = "Residential_Gas_Consumption"
  ) %>% 
  add_trace(
    data = pge_final_GasAndElec_Residential,
    x = ~Time %>% factor(),
    y = ~Residential_Electric_kBtu,
    type = "bar",
    name = "Residential_Electricity_Consumption"
  ) %>% 
  layout(
    legend=list(
      x = 0.1, y = 1.0,
      orientation = 'h'),
    title = "Residential gas/electricity consumption from 2017Q1 to 2021Q2", 
    xaxis = list(
      title = "Month/Year",
      fixedrange = T,
      tickformat  = "%m-%Y",
      type = "date",
      dtick = "M3"
    ),
    yaxis = list(
      title = "kBtu",
      fixedrange = T
    ),
    barmode = "stack"
  ) %>% 
  config(displayModeBar = F)
```

### 1.7  Create bar charts showing monthly total kBTUs of commercial electricity and gas consumption for the entire PG&E territory 

Time window: from the first quarter of 2017 to the second quarter of 2021

* The operation steps are almost the same as 1.1-1.6, and replace 'residential' with 'commercial'.

```{r}
pge_final_elec_Commercial <-
  pge_17toNow_elec %>% 
  filter(
    CUSTOMERCLASS %in% 
      c(
        "Elec- Commercial"
      )
  ) %>% 
  select(
    -c(COMBINED, AVERAGEKWH)
  ) %>% 
  group_by(YEAR, MONTH) %>% 
  summarize(
    TOTALKWH = 
      sum(
        TOTALKWH, 
        na.rm = T
      )
  ) %>% 
  mutate(
    Commercial_Electric_kBtu=3.412*TOTALKWH,
    Time=as.Date(as.yearmon(paste0(YEAR,'-',MONTH)))
  )
pge_final_elec_Commercial


pge_final_gas_Commercial <-
  pge_17toNow_gas %>% 
    filter(
      CUSTOMERCLASS %in% 
        c(
          "Gas- Commercial"
        )
    ) %>% 
    select(
      -c(COMBINED, AVERAGETHM)
    ) %>% 
    group_by(YEAR, MONTH) %>% 
    summarize(
      TOTALTHM = 
        sum(
          TOTALTHM, 
          na.rm = T
        )
    ) %>% 
    mutate(
      Commercial_Gas_kBtu=100.00039*TOTALTHM,
      Time=as.Date(as.yearmon(paste0(YEAR,'-',MONTH)))
    )
pge_final_gas_Commercial


pge_final_GasAndElec_Commercial<-
  merge(pge_final_gas_Commercial,pge_final_elec_Commercial,by=c("YEAR","MONTH","Time"))
  arrange(pge_final_GasAndElec_Commercial,pge_final_GasAndElec_Commercial$YEAR,pge_final_GasAndElec_Commercial$MONTH)

  
plot_ly() %>% 
  add_trace(
    data = pge_final_GasAndElec_Commercial,
    x = ~Time%>% factor(),
    y = ~Commercial_Gas_kBtu,
    type = "bar",
    name = "Commercial_Gas_Consumption"
  ) %>% 
  add_trace(
    data = pge_final_GasAndElec_Commercial,
    x = ~Time %>% factor(),
    y = ~Commercial_Electric_kBtu,
    type = "bar",
    name = "Commercial_Electricity_Consumption"
  ) %>% 
  layout(
    legend=list(
      x = 0.1, y = 1.0,
      orientation = 'h'),
    title = "Commercial gas/electricity consumption from 2017Q1 to 2021Q2", 
    xaxis = list(
      title = "Month/Year",
      fixedrange = T,
      tickformat  = "%m-%Y",
      type = "date",
      dtick = "M3"
    ),
    yaxis = list(
      title = "kBtu",
      fixedrange = T
    ),
    barmode = "stack"
  ) %>% 
  config(displayModeBar = F)
```
## 2 Analysis of observable changes 

### 2.1 Calculate the ratio of commercial to residential energy consumption

```{r}
pge_analysis_covid<-
  merge(pge_final_GasAndElec_Residential,pge_final_GasAndElec_Commercial,by=c("YEAR","MONTH","Time"))
  arrange(pge_analysis_covid,pge_analysis_covid$YEAR,pge_analysis_covid$MONTH)

pge_combined_analysis_covid <-
  pge_analysis_covid %>% 
  select(
    c("Commercial_Electric_kBtu",
      "Residential_Electric_kBtu",
      "Commercial_Gas_kBtu",
      "Residential_Gas_kBtu",
       "YEAR",
       "MONTH",
       "Time"))%>% 
  mutate(
    total_commercial_consumption = Commercial_Gas_kBtu + Commercial_Electric_kBtu,
    total_residential_consumption = Residential_Gas_kBtu + Residential_Electric_kBtu,
    Ratio_of_commercial_to_residential_consumption = 
      total_commercial_consumption/
      total_residential_consumption,
    Ratio_of_gas_to_elec_commercial = 
      Commercial_Gas_kBtu/
      Commercial_Electric_kBtu,
    Ratio_of_gas_to_elec_residential = 
      Residential_Gas_kBtu/
      Residential_Electric_kBtu,
    total_gas_residentialAndcommercial = 
      Residential_Gas_kBtu/
      Commercial_Gas_kBtu,
    total_electric_residentialAndcommercial = 
      Residential_Electric_kBtu/
      Commercial_Electric_kBtu,
    )
  
pge_combined_analysis_covid<-
  arrange(pge_combined_analysis_covid,pge_combined_analysis_covid$YEAR,pge_combined_analysis_covid$MONTH)
```
```{r}
plot_ly(pge_combined_analysis_covid,
        x = ~as.Date(Time),
        y = ~Ratio_of_commercial_to_residential_consumption,
        type = "scatter",
        mode = "lines",
        name = "Ratio of commercial to residential energy consumption") %>% 
  add_trace(x =as.Date("2020-3-11"),type = 'scatter', mode = 'lines',
            line = list(color = 'red'),name = 'Date of COVID-19 pandemic began according to WHO') %>%
  layout(
    #legend = list(title = list(text = "Description")),
    title = "Ratio of commercial to residential energy consumption from 2017Q1 to 2021Q2", 
    xaxis = list(
      title = "Month/Year",
      fixedrange = T,
      tickformat  = "%m-%Y",
      type = "date",
      dtick = "M3"
    ),
    yaxis = list(
      title = "Ratio",
      fixedrange = T
    )
  ) %>% 
  config(displayModeBar = F)
```

*The World Health Organization (WHO) declared a Public Health Emergency of International Concern on 30 January 2020, and a pandemic on 11 March 2020. 

```{r}
plot_ly(pge_combined_analysis_covid,
        x = ~as.Date(Time),
        y = ~total_gas_residentialAndcommercial,
        type = "bar",
        name = "total gas consumption - residential and commercial") %>% 
  add_trace(x =as.Date("2020-3-11"),type = 'scatter', mode = 'lines',
            line = list(color = 'red'),name = 'Date of COVID-19 pandemic began according to WHO') %>%
  layout(
    #legend = list(title = list(text = "Description")),
    title = "total gas consumption - residential and commercial - from 2017Q1 to 2021Q2", 
    xaxis = list(
      title = "Month/Year",
      fixedrange = T,
      tickformat  = "%m-%Y",
      type = "date",
      dtick = "M3"
    ),
    yaxis = list(
      title = "Ratio",
      fixedrange = T
    )
  ) %>% 
  config(displayModeBar = F)
```
```{r}
plot_ly(pge_combined_analysis_covid,
        x = ~as.Date(Time),
        y = ~total_electric_residentialAndcommercial,
        type = "bar",
        name = "total electricity consumption - residential and commercial") %>% 
  add_trace(x =as.Date("2020-3-11"),type = 'scatter', mode = 'lines',
            line = list(color = 'red'),name = 'Date of COVID-19 pandemic began according to WHO') %>%
  layout(
    #legend = list(title = list(text = "Description")),
    title = "total electricity consumption - residential and commercial - from 2017Q1 to 2021Q2", 
    xaxis = list(
      title = "Month/Year",
      fixedrange = T,
      tickformat  = "%m-%Y",
      type = "date",
      dtick = "M3"
    ),
    yaxis = list(
      title = "Ratio",
      fixedrange = T
    )
  ) %>% 
  config(displayModeBar = F)
```

### 2.2 Comment on observable changes in energy consumption that may be attributable to the COVID-19 pandemic

(1) In the chart "Ratio of commercial to residential energy consumption", I used the red line to mark the time when WHO declared a pandemic (according to WHO). It can be seen that after this time point, the ratio of commercial energy consumption to residential energy consumption has dropped significantly. This is in line with our perception that due to the epidemic, people spend more time at home instead of in commercial buildings.

(2) Starting from the first quarter of 2021, the ratio of commercial energy consumption to residential energy consumption has rebounded significantly. This may be due to the liberalization of restrictions on the COVID-19 in various regions. The implementation of the epidemic control  policy is no longer that mandatory. More people choose to return to commercial buildings. As of the second quarter of 2021, this ratio is basically the same as the second quarter of 2019. Compared with the same period before the pandemic, there was even a slight improvement.

(3) According to the chart "total gas consumption - residential and commercial", since the first quarter of 2017, the gas consumption of commercial and residential buildings has been showing a downward trend. However, after the outbreak of the epidemic, this downward trend no longer continued, and the total gas consumption increased.

(4) According to the chart "total electricity consumption - residential and commercial", since the outbreak of the epidemic, total electricity consumption has risen significantly. This may be due to the significant increase in the amount of time people spend indoors during the epidemic, and the decrease in outdoor activities, leading to an increase in electricity consumption. Starting from the first quarter of 2021, such high-level electricity consumption has dropped again. This may be because the impact of the epidemic on people's normal lives has been significantly reduced, and the total electricity consumption has basically fallen to the level before the epidemic.